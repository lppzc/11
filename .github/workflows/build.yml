name: C++ 项目编译（Windows + Qt6）

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: windows-latest
    env:
      QT_INSTALL_DIR: ${{ github.workspace }}/Qt

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 MSYS2 及 MinGW 工具链
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-g++
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-libstdc++6

      - name: 验证 MinGW 环境
        shell: msys2 {0}
        run: |
          gcc --version
          g++ --version
          cmake --version

      - name: 安装 Qt6
        uses: jurplel/install-qt-action@v3
        id: install-qt
        with:
          version: '6.6.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw'
          install-deps: true
          modules: >-
            qtbase-devel
            qttools-devel
            qtwidgets-devel
            qtgui-devel
            qtcore-devel
          dir: ${{ env.QT_INSTALL_DIR }}

      - name: CMake 配置
        shell: msys2 {0}
        run: |
          cmake -B build -G "Unix Makefiles" \
            -DCMAKE_PREFIX_PATH="${{ steps.install-qt.outputs.qt_dir }}" \
            -DCMAKE_BUILD_TYPE=Release

      - name: 编译项目
        shell: msys2 {0}
        run: |
          cmake --build build --config Release -j4

      - name: 复制 Qt 运行时依赖
        shell: msys2 {0}
        run: |
          ${{ steps.install-qt.outputs.qt_dir }}/bin/windeployqt.exe \
            --release \
            build/todolist.exe

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: todolist-windows
          path: build/
