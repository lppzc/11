# .github/workflows/build-android.yml
name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Install Android SDK/NDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33  # 目标Android API级别
        ndk-version: 25.1.8937393  # 兼容Qt6的NDK版本
        build-tools-version: 33.0.2
    
    - name: Install Qt for Android
      uses: jurplel/install-qt-action@v4
      with:
        version: 6.5.2
        host: windows
        target: android
        arch: android_arm64_v8a  # 目标架构（arm64-v8a，主流设备兼容）
        cache: true
        modules: 'qtbase qtgui qtwidgets'  # 必要Qt模块
    
    - name: Configure CMake for Android
      run: |
        mkdir -p build-android
        cd build-android
        cmake .. -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_SYSTEM_NAME=Android \
          -DCMAKE_ANDROID_API_LEVEL=33 \
          -DCMAKE_ANDROID_NDK=${{ env.ANDROID_NDK_ROOT }} \
          -DCMAKE_ANDROID_STL_TYPE=c++_shared \
          -DCMAKE_PREFIX_PATH=${{ env.Qt6_DIR }}
      shell: bash
    
    - name: Build APK (via CMake-Gradle)
      run: |
        cd build-android
        cmake --build . --config Release --target apk
      shell: bash
    
    - name: Locate APK
      id: find-apk
      run: |
        APK_PATH=$(find build-android -name "*.apk" | head -n 1)
        echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
      shell: bash
    
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: todolist-android-apk
        path: ${{ env.APK_PATH }}
